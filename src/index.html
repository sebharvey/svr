<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Severn Valley Live Train Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            color: #fff;
        }
        
        .controls {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .time-display {
            background: #3a3a3a;
            color: #e0e0e0;
            border: 1px solid #4a4a4a;
            padding: 6px 15px;
            border-radius: 4px;
            font: bold 16px/1;
            min-width: 80px;
            text-align: center;
        }
        
        .time-btn,
        .live-btn {
            background: #4a4a4a;
            color: #e0e0e0;
            border: 1px solid #5a5a5a;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color .2s;
        }
        
        .time-btn {
            padding: 6px 12px;
            font-size: 18px;
        }
        
        .time-btn:hover,
        .live-btn:hover:not(:disabled) {
            background: #5a5a5a;
        }
        
        .time-btn:active {
            background: #3a3a3a;
        }
        
        .live-btn {
            padding: 8px 20px;
            font-size: 14px;
        }
        
        .live-btn:disabled {
            background: #2a2a2a;
            border-color: #3a3a3a;
            color: #666;
            cursor: not-allowed;
        }
        
        .tracker-container,
        .status-panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin: 0 auto 20px;
            max-width: 800px;
        }
        
        .station {
            background: #404040;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 2px;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .station-name {
            font-weight: bold;
            font-size: 16px;
            z-index: 1;
        }
        
        .track-section {
            background: #333;
            position: relative;
            min-height: 100px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
        }
        
        .track-line {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #555;
            transform: translateX(-50%);
        }
        
        .train {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 2;
        }
        
        .train.northbound {
            left: 10%;
            flex-direction: row;
        }
        
        .train.southbound {
            right: 10%;
            flex-direction: row-reverse;
        }
        
        .train-icon {
            font-size: 20px;
        }
        
        .train-label {
            display: flex;
            flex-direction: column;
            font-size: 11px;
        }
        
        .train-number {
            font-weight: bold;
        }
        
        .direction-arrow {
            font-size: 14px;
        }
        
        .status-panel h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #fff;
        }
        
        .train-status {
            background: #333;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .train-status-header {
            font-weight: bold;
            margin-bottom: 6px;
            font-size: 14px;
        }
        
        .train-status-detail {
            font-size: 13px;
            color: #b0b0b0;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls label {
                justify-content: space-between;
            }
            
            .train {
                font-size: 11px;
            }
            
            .train-icon {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <h1>Severn Valley Live Train Tracker</h1>
    
    <div class="controls" id="controls" style="display: none;">
        <div class="time-input-group">
            <button class="time-btn" id="timeDown">◀</button>
            <div class="time-display" id="timeDisplay">08:00</div>
            <button class="time-btn" id="timeUp">▶</button>
        </div>
        <button class="live-btn" id="liveBtn" disabled>Live Time</button>
    </div>
    
    <div class="tracker-container" id="trackerContainer"></div>
    
    <div class="status-panel">
        <h2>Train Status</h2>
        <div id="statusContainer"></div>
    </div>

    <script>
        // Check for debug query string
        const urlParams = new URLSearchParams(window.location.search);
        const debugMode = urlParams.get('debug') === 'true';
        
        // Show controls if debug mode is enabled
        if (debugMode) {
            document.getElementById('controls').style.display = 'flex';
        }
        
        const timetableData = {
  "route": "Kidderminster - Bridgnorth",
  "date": "Saturday 11 October only",
  "trains": [
    {
      "trainNumber": "Diesel 37248",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "09:40", "stopsAt": true },
        { "station": "Hampton Loade", "time": "09:58", "stopsAt": false },
        { "station": "Highley", "time": "10:08", "stopsAt": false },
        { "station": "Arley", "time": "10:20", "stopsAt": false },
        { "station": "Bewdley", "arrival": "10:24", "departure": "10:27", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "10:40", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel DMU",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "10:45", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "11:07", "departure": "11:10", "stopsAt": true },
        { "station": "Highley", "arrival": "11:17", "departure": "11:20", "stopsAt": true },
        { "station": "Arley", "arrival": "11:29", "departure": "11:32", "stopsAt": true },
        { "station": "Bewdley", "arrival": "11:44", "departure": "11:47", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "12:00", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Steam 75069",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "12:20", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "12:35", "departure": "12:38", "stopsAt": true },
        { "station": "Highley", "arrival": "12:45", "departure": "12:48", "stopsAt": true },
        { "station": "Arley", "arrival": "12:59", "departure": "13:02", "stopsAt": true },
        { "station": "Bewdley", "arrival": "13:14", "departure": "13:17", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "13:30", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "13:00", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "13:22", "departure": "13:25", "stopsAt": true },
        { "station": "Highley", "arrival": "13:35", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel DMU",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "13:45", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "14:02", "departure": "14:05", "stopsAt": true },
        { "station": "Highley", "arrival": "14:14", "departure": "14:17", "stopsAt": true },
        { "station": "Arley", "arrival": "14:27", "departure": "14:30", "stopsAt": true },
        { "station": "Bewdley", "arrival": "14:42", "departure": "14:45", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "14:57", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "14:40", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "14:55", "departure": "14:58", "stopsAt": true },
        { "station": "Highley", "arrival": "15:07", "departure": "15:10", "stopsAt": true },
        { "station": "Arley", "arrival": "15:17", "departure": "15:20", "stopsAt": true },
        { "station": "Bewdley", "arrival": "15:32", "departure": "15:35", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "15:55", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Steam 75069",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "15:50", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "16:05", "departure": "16:08", "stopsAt": true },
        { "station": "Highley", "arrival": "16:15", "departure": "16:18", "stopsAt": true },
        { "station": "Arley", "arrival": "16:29", "departure": "16:32", "stopsAt": true },
        { "station": "Bewdley", "arrival": "16:44", "departure": "16:47", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "17:02", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "northbound",
      "stops": [
        { "station": "Bridgnorth", "departure": "18:00", "stopsAt": true },
        { "station": "Hampton Loade", "time": "18:18", "stopsAt": false },
        { "station": "Highley", "time": "18:28", "stopsAt": false },
        { "station": "Arley", "time": "18:40", "stopsAt": false },
        { "station": "Bewdley", "arrival": "18:42", "departure": "18:45", "stopsAt": true },
        { "station": "Kidderminster", "arrival": "18:57", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "08:15", "stopsAt": true },
        { "station": "Bewdley", "arrival": "08:27", "departure": "08:30", "stopsAt": true },
        { "station": "Arley", "time": "08:42", "stopsAt": false },
        { "station": "Highley", "time": "08:54", "stopsAt": false },
        { "station": "Hampton Loade", "time": "09:04", "stopsAt": false },
        { "station": "Bridgnorth", "arrival": "09:13", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Steam 75069",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "10:15", "stopsAt": true },
        { "station": "Bewdley", "arrival": "10:27", "departure": "10:30", "stopsAt": true },
        { "station": "Arley", "arrival": "10:42", "departure": "10:45", "stopsAt": true },
        { "station": "Highley", "arrival": "10:54", "departure": "10:57", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "11:07", "departure": "11:10", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "11:25", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "11:00", "stopsAt": true },
        { "station": "Bewdley", "arrival": "11:12", "departure": "11:15", "stopsAt": true },
        { "station": "Arley", "arrival": "11:30", "departure": "11:33", "stopsAt": true },
        { "station": "Highley", "arrival": "11:42", "departure": "11:45", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "11:55", "departure": "11:58", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "12:13", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel DMU",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "12:30", "stopsAt": true },
        { "station": "Bewdley", "arrival": "12:42", "departure": "12:45", "stopsAt": true },
        { "station": "Arley", "arrival": "13:00", "departure": "13:03", "stopsAt": true },
        { "station": "Highley", "arrival": "13:11", "departure": "13:14", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "13:22", "departure": "13:25", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "13:40", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "southbound",
      "stops": [
        { "station": "Highley", "departure": "13:52", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "14:02", "departure": "14:05", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "14:20", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Steam 75069",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "14:00", "stopsAt": true },
        { "station": "Bewdley", "arrival": "14:12", "departure": "14:15", "stopsAt": true },
        { "station": "Arley", "arrival": "14:27", "departure": "14:30", "stopsAt": true },
        { "station": "Highley", "arrival": "14:39", "departure": "14:42", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "14:55", "departure": "14:58", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "15:13", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel DMU",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "15:50", "stopsAt": true },
        { "station": "Bewdley", "arrival": "16:07", "departure": "16:10", "stopsAt": true },
        { "station": "Arley", "arrival": "16:30", "departure": "16:33", "stopsAt": true },
        { "station": "Highley", "arrival": "16:41", "departure": "16:44", "stopsAt": true },
        { "station": "Hampton Loade", "arrival": "16:52", "departure": "16:55", "stopsAt": true },
        { "station": "Bridgnorth", "arrival": "17:10", "stopsAt": true }
      ]
    },
    {
      "trainNumber": "Diesel 37248",
      "direction": "southbound",
      "stops": [
        { "station": "Kidderminster", "departure": "16:30", "stopsAt": true },
        { "station": "Bewdley", "arrival": "16:44", "departure": "16:47", "stopsAt": true },
        { "station": "Arley", "time": "16:59", "stopsAt": false },
        { "station": "Highley", "time": "17:09", "stopsAt": false },
        { "station": "Hampton Loade", "time": "17:19", "stopsAt": false },
        { "station": "Bridgnorth", "arrival": "17:30", "stopsAt": true }
      ]
    }
  ]
};

        // Extract stations dynamically from timetable data
        // Build ordered list by following the first complete route
        function extractStations() {
            // Find a service with all stops to get the complete station order
            // Use the first northbound service as it goes from last to first station
            const referenceService = timetableData.trains.find(t => t.direction === 'northbound');
            if (!referenceService) {
                // Fallback to any service
                return [...new Set(timetableData.trains[0].stops.map(s => s.station))];
            }
            
            // For northbound, stations go from last to first (Bridgnorth to Kidderminster)
            // We want to display top to bottom (Kidderminster to Bridgnorth)
            const stationsInRoute = referenceService.stops.map(s => s.station);
            return stationsInRoute.reverse(); // Reverse to get Kidderminster at top
        }
        
        const stations = extractStations();
        
        // Assign unique colors to each unique train number dynamically from timetable
        const trainColors = {};
        const colorPalette = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#fd79a8', '#fdcb6e', '#6c5ce7', '#a29bfe', '#74b9ff'];
        
        // Extract unique train numbers from timetable and sort alphabetically
        const uniqueTrains = [...new Set(timetableData.trains.map(t => t.trainNumber))].sort();
        
        // Assign colors based on alphabetical order
        uniqueTrains.forEach((trainNumber, index) => {
            trainColors[trainNumber] = colorPalette[index % colorPalette.length];
        });
        
        function getTrainColor(trainNumber) {
            return trainColors[trainNumber] || '#888888';
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        }
        
        function getTrainIcon(trainNumber) {
            if (trainNumber.includes('Steam')) return '🚂';
            if (trainNumber.includes('DMU')) return '🚃';
            return '🚆';
        }
        
        // Manual time state - initialize to current time
        const now = new Date();
        let manualTime = now.getHours() * 60 + now.getMinutes();
        let isLiveMode = true;
        
        function updateTimeDisplay() {
            if (isLiveMode) {
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();
                document.getElementById('timeDisplay').textContent = formatTime(currentTime);
            } else {
                document.getElementById('timeDisplay').textContent = formatTime(manualTime);
            }
        }
        
        function updateLiveButton() {
            const btn = document.getElementById('liveBtn');
            btn.disabled = isLiveMode;
        }
        
        function getCurrentTime() {
            if (isLiveMode) {
                const now = new Date();
                return now.getHours() * 60 + now.getMinutes();
            } else {
                return manualTime;
            }
        }
        
        function getStopTime(stop) {
            return parseTime(stop.departure || stop.arrival || stop.time);
        }
        
        function findTrainPosition(train, currentTime) {
            const stops = train.stops;
            
            // Check if train hasn't started yet
            const firstStop = stops[0];
            const startTime = getStopTime(firstStop);
            
            // Show train at terminal station 15 minutes before departure
            if (currentTime < startTime) {
                const isTerminalStation = firstStop.station === stations[0] || firstStop.station === stations[stations.length - 1];
                if (isTerminalStation && currentTime >= startTime - 15) {
                    return {
                        type: 'at_station',
                        station: firstStop.station,
                        waitingForDeparture: true
                    };
                }
                return null;
            }
            
            // Check if train has completed journey
            const lastStop = stops[stops.length - 1];
            const endTime = getStopTime(lastStop);
            
            // If train has finished this service
            if (currentTime > endTime) {
                // Check if there's a future service for this train
                const lastStation = lastStop.station;
                const nextService = getNextService(train.trainNumber, lastStation, currentTime);
                
                if (nextService) {
                    // Train is waiting at terminus for next service
                    return {
                        type: 'at_station',
                        station: lastStation
                    };
                } else {
                    // No future service - remove after 15 minutes
                    if (currentTime > endTime + 15) {
                        return null;
                    }
                    return {
                        type: 'at_station',
                        station: lastStation
                    };
                }
            }
            
            // Find current segment
            for (let i = 0; i < stops.length - 1; i++) {
                const currentStop = stops[i];
                const nextStop = stops[i + 1];
                
                const departTime = currentStop.departure ? parseTime(currentStop.departure) : getStopTime(currentStop);
                const arriveTime = nextStop.arrival ? parseTime(nextStop.arrival) : getStopTime(nextStop);
                
                if (currentTime >= departTime && currentTime <= arriveTime) {
                    // Train is between stations
                    const progress = (currentTime - departTime) / (arriveTime - departTime);
                    return {
                        type: 'between',
                        fromStation: currentStop.station,
                        toStation: nextStop.station,
                        progress: progress,
                        departTime: departTime,
                        arriveTime: arriveTime
                    };
                }
                
                // Check if at a station (between arrival and departure)
                if (currentStop.arrival && currentStop.departure) {
                    const arrivalTime = parseTime(currentStop.arrival);
                    const departureTime = parseTime(currentStop.departure);
                    if (currentTime >= arrivalTime && currentTime < departureTime) {
                        return {
                            type: 'at_station',
                            station: currentStop.station
                        };
                    }
                }
            }
            
            // Should not reach here, but return at final station as fallback
            return {
                type: 'at_station',
                station: lastStop.station
            };
        }
        
        function getNextService(trainNumber, currentStation, currentTime) {
            // Find any service with the same train number that departs from the current station
            const services = timetableData.trains.filter(t => t.trainNumber === trainNumber);
            
            for (let service of services) {
                const firstStop = service.stops[0];
                const startTime = getStopTime(firstStop);
                // Check that the service starts from the current station and is in the future
                if (startTime > currentTime && firstStop.station === currentStation) {
                    return {
                        service: service,
                        departTime: startTime
                    };
                }
            }
            return null;
        }
        
        function generateStatusText(train, position, currentTime) {
            const stops = train.stops;
            
            if (!position) {
                return null;
            }
            
            if (position.type === 'at_station') {
                const isTerminus = position.station === stations[0] || position.station === stations[stations.length - 1];
                
                // Check if this is a pre-departure waiting position
                if (position.waitingForDeparture) {
                    const firstStop = stops[0];
                    const departTime = getStopTime(firstStop);
                    const minutesUntil = departTime - currentTime;
                    return `Waiting at ${position.station}, departing at ${formatTime(departTime)} (departing in ${minutesUntil} minute${minutesUntil !== 1 ? 's' : ''})`;
                }
                
                if (isTerminus) {
                    const nextService = getNextService(train.trainNumber, position.station, currentTime);
                    if (nextService) {
                        const minutesUntil = nextService.departTime - currentTime;
                        return `Waiting at ${position.station}, next departure at ${formatTime(nextService.departTime)} (departing in ${minutesUntil} minute${minutesUntil !== 1 ? 's' : ''})`;
                    } else {
                        return `Terminated at ${position.station}`;
                    }
                }
                
                // At intermediate station
                const currentStopIndex = stops.findIndex(s => s.station === position.station);
                const currentStop = stops[currentStopIndex];
                if (currentStop.departure) {
                    const nextStop = stops[currentStopIndex + 1];
                    const departTime = parseTime(currentStop.departure);
                    const minutesUntil = departTime - currentTime;
                    return `At ${position.station}, departing at ${currentStop.departure} (in ${minutesUntil} minute${minutesUntil !== 1 ? 's' : ''}) → ${nextStop.station}`;
                }
            }
            
            if (position.type === 'between') {
                const minutesUntilArrival = position.arriveTime - currentTime;
                const arrivalText = minutesUntilArrival === 0 ? 'arriving now' : `arriving ${formatTime(position.arriveTime)} in ${minutesUntilArrival} minute${minutesUntilArrival !== 1 ? 's' : ''}`;
                
                // Check for non-stop stations
                let statusParts = [`Traveling from ${position.fromStation} (departed ${formatTime(position.departTime)}) → ${position.toStation} (${arrivalText})`];
                
                // Find stations being passed without stopping
                const fromIndex = stations.indexOf(position.fromStation);
                const toIndex = stations.indexOf(position.toStation);
                const intermediateStations = train.direction === 'northbound' 
                    ? stations.slice(fromIndex + 1, toIndex)
                    : stations.slice(toIndex + 1, fromIndex);
                
                for (let station of intermediateStations) {
                    const stopInfo = stops.find(s => s.station === station);
                    if (stopInfo && !stopInfo.stopsAt) {
                        const passTime = getStopTime(stopInfo);
                        const minutesUntilPass = passTime - currentTime;
                        if (minutesUntilPass > 0) {
                            statusParts.push(`Passing ${station} in ${minutesUntilPass} minute${minutesUntilPass !== 1 ? 's' : ''}`);
                        }
                    }
                }
                
                return statusParts.join(' • ');
            }
            
            return null;
        }
        
        function renderTracker() {
            const container = document.getElementById('trackerContainer');
            const currentTime = getCurrentTime();
            container.innerHTML = '';
            
            // Track active trains by train number only (not direction)
            const activeTrains = {};
            
            for (let train of timetableData.trains) {
                const position = findTrainPosition(train, currentTime);
                if (position) {
                    const key = train.trainNumber;
                    
                    // If this train number already exists, we need to pick the right service
                    if (activeTrains[key]) {
                        const existingTrain = activeTrains[key].train;
                        const existingPosition = activeTrains[key].position;
                        
                        const currentStartTime = getStopTime(train.stops[0]);
                        const currentEndTime = getStopTime(train.stops[train.stops.length - 1]);
                        const existingStartTime = getStopTime(existingTrain.stops[0]);
                        const existingEndTime = getStopTime(existingTrain.stops[existingTrain.stops.length - 1]);
                        
                        // Check if services are currently running (between start and end)
                        const currentIsRunning = currentTime >= currentStartTime && currentTime <= currentEndTime;
                        const existingIsRunning = currentTime >= existingStartTime && currentTime <= existingEndTime;
                        
                        // Priority 1: Currently running service
                        if (currentIsRunning && !existingIsRunning) {
                            activeTrains[key] = { train, position };
                        }
                        else if (!currentIsRunning && existingIsRunning) {
                            // Keep existing
                        }
                        // Both running: prioritize moving trains
                        else if (currentIsRunning && existingIsRunning) {
                            if (position.type === 'between' && existingPosition.type === 'at_station') {
                                activeTrains[key] = { train, position };
                            }
                        }
                        // Neither running: both are waiting or pre-departure
                        else {
                            // If current has finished and existing hasn't started (waiting for departure)
                            const currentHasFinished = currentTime > currentEndTime;
                            const existingHasFinished = currentTime > existingEndTime;
                            
                            if (currentHasFinished && !existingHasFinished) {
                                // Current service has finished, existing hasn't started - use current (it's waiting)
                                activeTrains[key] = { train, position };
                            }
                            else if (existingHasFinished && !currentHasFinished) {
                                // Keep existing (it's waiting)
                            }
                            else if (currentHasFinished && existingHasFinished) {
                                // Both finished - keep the most recent one
                                if (currentEndTime > existingEndTime) {
                                    activeTrains[key] = { train, position };
                                }
                            }
                        }
                    } else {
                        activeTrains[key] = { train, position };
                    }
                }
            }
            
            // Render stations and tracks
            for (let i = 0; i < stations.length; i++) {
                const station = stations[i];
                
                // Create station div
                const stationDiv = document.createElement('div');
                stationDiv.className = 'station';
                stationDiv.innerHTML = `<div class="station-name">${station}</div>`;
                
                // Add trains at this station
                for (let key in activeTrains) {
                    const { train, position } = activeTrains[key];
                    if (position.type === 'at_station' && position.station === station) {
                        const trainDiv = createTrainElement(train, 50);
                        stationDiv.appendChild(trainDiv);
                    }
                }
                
                container.appendChild(stationDiv);
                
                // Create track section (except after last station)
                if (i < stations.length - 1) {
                    const trackDiv = document.createElement('div');
                    trackDiv.className = 'track-section';
                    trackDiv.innerHTML = '<div class="track-line"></div>';
                    
                    const nextStation = stations[i + 1];
                    
                    // Add trains between stations
                    for (let key in activeTrains) {
                        const { train, position } = activeTrains[key];
                        if (position.type === 'between') {
                            // For northbound: from is lower station, to is upper station
                            // For southbound: from is upper station, to is lower station
                            // Track sections go from current station to next (upward in list)
                            let matchesSegment = false;
                            
                            if (train.direction === 'northbound') {
                                // Northbound goes from Bridgnorth to Kidderminster (bottom to top)
                                matchesSegment = position.fromStation === nextStation && position.toStation === station;
                            } else {
                                // Southbound goes from Kidderminster to Bridgnorth (top to bottom)
                                matchesSegment = position.fromStation === station && position.toStation === nextStation;
                            }
                            
                            if (matchesSegment) {
                                // progress goes 0 to 1 from departure to arrival
                                // For northbound: start at bottom (100%) and move to top (0%)
                                // For southbound: start at top (0%) and move to bottom (100%)
                                const percentage = train.direction === 'northbound' 
                                    ? (1 - position.progress) * 100 
                                    : position.progress * 100;
                                const trainDiv = createTrainElement(train, percentage);
                                trackDiv.appendChild(trainDiv);
                            }
                        }
                    }
                    
                    container.appendChild(trackDiv);
                }
            }
            
            // Render status panel
            renderStatus(activeTrains, currentTime);
        }
        
        function createTrainElement(train, topPercentage) {
            const trainDiv = document.createElement('div');
            trainDiv.className = `train ${train.direction}`;
            trainDiv.style.top = `${topPercentage}%`;
            trainDiv.style.transform = 'translateY(-50%)';
            
            const color = getTrainColor(train.trainNumber);
            trainDiv.style.backgroundColor = color + '33';
            trainDiv.style.borderLeft = `3px solid ${color}`;
            
            const icon = getTrainIcon(train.trainNumber);
            const arrow = train.direction === 'northbound' ? '↑' : '↓';
            
            trainDiv.innerHTML = `
                <div class="train-label">
                    <span class="train-number">${train.trainNumber}</span>
                </div>
                <span class="train-icon">${icon}</span>
                <span class="direction-arrow">${arrow}</span>
            `;
            
            return trainDiv;
        }
        
        function renderStatus(activeTrains, currentTime) {
            const container = document.getElementById('statusContainer');
            container.innerHTML = '';
            
            if (Object.keys(activeTrains).length === 0) {
                container.innerHTML = '<div style="color: #888;">No trains currently active</div>';
                return;
            }
            
            for (let key in activeTrains) {
                const { train, position } = activeTrains[key];
                const statusText = generateStatusText(train, position, currentTime);
                
                if (statusText) {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'train-status';
                    const color = getTrainColor(train.trainNumber);
                    statusDiv.style.borderLeftColor = color;
                    
                    statusDiv.innerHTML = `
                        <div class="train-status-header">${train.trainNumber} (${train.direction})</div>
                        <div class="train-status-detail">${statusText}</div>
                    `;
                    
                    container.appendChild(statusDiv);
                }
            }
        }
        
        // Event listeners
        document.getElementById('timeUp').addEventListener('click', () => {
            if (isLiveMode) {
                const now = new Date();
                manualTime = now.getHours() * 60 + now.getMinutes();
                isLiveMode = false;
            }
            manualTime += 5;
            if (manualTime >= 24 * 60) manualTime = 0;
            updateTimeDisplay();
            updateLiveButton();
            renderTracker();
            startAutoRefresh();
        });
        
        document.getElementById('timeDown').addEventListener('click', () => {
            if (isLiveMode) {
                const now = new Date();
                manualTime = now.getHours() * 60 + now.getMinutes();
                isLiveMode = false;
            }
            manualTime -= 5;
            if (manualTime < 0) manualTime = 24 * 60 - 5;
            updateTimeDisplay();
            updateLiveButton();
            renderTracker();
            startAutoRefresh();
        });
        
        document.getElementById('liveBtn').addEventListener('click', () => {
            isLiveMode = true;
            updateTimeDisplay();
            updateLiveButton();
            renderTracker();
            startAutoRefresh();
        });
        
        // Auto-refresh in live mode
        let refreshInterval;
        
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            
            if (isLiveMode) {
                refreshInterval = setInterval(() => {
                    updateTimeDisplay();
                    renderTracker();
                }, 30000); // 30 seconds
            }
        }
        
        // Initial render
        updateTimeDisplay();
        updateLiveButton();
        renderTracker();
        startAutoRefresh();
    </script>
</body>
</html>
